@{
    ViewData["Title"] = "Survey Data";
}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link href="css/d3.parsets.css" rel="stylesheet" />
<link href="lib/UI-Dropdown-master/dropdown.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/css/select2.min.css" rel="stylesheet" />
<link href="css/visstyles.css" rel="stylesheet" />

<div class="widget">
    <div id="filter-container">
        <div class="legend">Filters <div class="filter-show">[Show]</div></div>
    </div>
    <div id="select-container">
        <div class="legend">Display selection <div class="filter-show">[Show]</div></div>
        <fieldset>
            <ul class="list-group list-group-sortable csvcolumn-list"></ul>
        </fieldset>

    </div>
    <div id="vis-container">
        <div id="inline-validationtext" style="display:none;">Please select at least one value</div>
        <div id="generate">Generate chart</div>
        <div id="plotly-bar"></div>
        <div id="plotly-pie"></div>
        <div id="vis"></div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="js/d3.min.js"></script>
<script src="https://d3js.org/d3-array.v2.min.js"></script>
<script src="js/d3.parsets.js"></script>
<script src="js/highlight.js"></script>
<script src="js/jquery.sortable.js"></script>
<script src="lib/UI-Dropdown-master/dropdown.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/select2.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
    var data;
    var datacolumns;
    var i;
    var datasummary = [];
    var filter_on = 'Country';

    function column(a, b) {
        this.title = a;
        this.values = b;
    }

    function groupbardata(a, b, c, d) {
        this.x = a;
        this.y = b;
        this.name = c;
        this.type = d;
    }

    d3.rebind = function (target, source) {
        var i = 1, n = arguments.length, method;
        while (++i < n) target[method = arguments[i]] = d3_rebind(target, source, source[method]);
        return target;
    };

    function d3_rebind(target, source, method) {
        return function () {
            var value = method.apply(source, arguments);
            return value === source ? target : value;
        };
    }

    d3.functor = function functor(v) {
        return typeof v === "function" ? v : function () {
            return v;
        };
    };

    function filterevents() {
        $('.filter-list-item').click(function () {
            $(this).parent().parent().toggleClass('filter-selected')
        })

        $('.filter-show').click(function () {
            $(this).parent().parent().toggleClass('visible')
            var text = $(this).text();
            $(this).text(
                text == "[Show]" ? "[Hide]" : "[Show]");
        })
    }

    function filterSelectConstructor() {

        d3.csv('All_data_with_dates_and_filtered.csv', function (error, csv) {
            datacolumns = d3.keys(csv[0]);
            datacolumnssize = datacolumns.length;

            for (i = 2; i < datacolumns.length; i++) {
                var columnname = datacolumns[i];
                var columnuniques = d3.map(csv, function (d) { return d[datacolumns[i]]; }).keys();
                console.log(columnname);
                console.log(columnuniques);
                var columnsummary = new column(columnname, columnuniques)
                console.log(columnsummary);
                datasummary.push(columnsummary);
            }
            console.log('Data summary has ' + datasummary.length + ' objects');
            console.log(datasummary);

            var collator = new Intl.Collator(undefined, {
                numeric: true,
                sensitivity: 'base'
            });

            for (i = 2; i < datacolumnssize; i++) {

                $('.csvcolumn-list').append('<li class="list-group-item" draggable="true"> <label class="filter-label filter-label-check" for= "check-' + datacolumns[i] + '">' + datacolumns[i] + '<input class="filter-list-item" type="checkbox" name="qselector" id="check-' + datacolumns[i] + '" value="' + datacolumns[i] + '"><span class="checkmark"></span></label ></li>');
            }

            $('.list-group-sortable').sortable({
                placeholderClass: 'list-group-item'
            });

            for (i = 0; i < datasummary.length; i++) {

                var filter_title = datasummary[i].title;
                console.log('Beginning build of' + filter_title + ' filter');
                var filter_uniques = datasummary[i].values;

                $("#filter-container").append('<select class="js-example-basic-multiple ' + filter_title + '-filter" multiple="" style="width:320px;""></select>');
                $("." + filter_title + "-filter").append('<option value="">' + filter_title + '</option>');

                for (j = 0; j < filter_uniques.length; j++) {
                    $("." + filter_title + "-filter").append('<option value="' + filter_uniques[j] + '">' + filter_uniques[j] + '</option>');
                }

                $('.' + filter_title + "-filter").select2({
                    width: '100%',
                    placeholder: filter_title,
                    tags: true
                });

            }


            filterevents();
        });


    };

    filterSelectConstructor();
</script>

<script>
    var qselectorarray;
    var filterarray;
    var filtercount;


    function qselector() {
        qselectorarray = [];
        console.log("qselectorarray reset");
        $("input:checkbox[name=qselector]:checked").each(function () {
            qselectorarray.push($(this).val());
            console.log("qselectorarray array added")
        });
    }

    function filterselect() {
        filterarray = [];
        filtercount = 0;
        for (i = 0; i < datasummary.length; i++) {
            var filterselected = [];
            $('.' + datasummary[i].title + '-filter').find(':selected').each(function () {
                filterselected.push($(this).val());
                console.log(filterselected)
                filtercount++;
                console.log(filtercount)
            });
            if (filterselected.length > 0) { filterarray.push(new column(datasummary[i].title, filterselected)) }

        }
        console.log(filterarray)
    }

    function singlechart(csv) {
        if (qselectorarray === undefined || qselectorarray === null) {
            qselectorarray[0] = "Country";
        }
        filterselect();

        if (filtercount > 0) {
            var data = csv;

            for (j = 0; j < filterarray.length; j++) {
                var t;
                t = data.filter(function (d, i) { return filterarray[j].values.indexOf(d[filterarray[j].title]) >= 0 });
                data = t;
            }
        } else {
            var data = csv; // so that no boxes checked shows all data
        }



        filter = qselectorarray[0];


        var rolledup = d3.rollup(data, v => v.length, d => d[filter]);
        console.log(rolledup);

        rolleduparray = Array.from(rolledup);
        console.log(rolleduparray);

        rolleduparray.sort(function (x, y) { return d3.ascending(x[0], y[0]); });

        var x = [];
        var y = [];

        for (i = 0; i < rolleduparray.length; i++) {
            x.push(rolleduparray[i][0]);
            y.push(rolleduparray[i][1]);
        }

        var bardata = [
            {
                x: x,
                y: y,
                type: 'bar'
            }
        ];
        var piedata = [
            {
                labels: x,
                values: y,
                type: 'pie',
                textinfo: 'none',
                hole: .4
            }
        ];

        Plotly.newPlot('plotly-bar', bardata, { responsive: true });
        Plotly.newPlot('plotly-pie', piedata, { responsive: true });
    }

    function groupchart(csv) {
        if (qselectorarray === undefined || qselectorarray === null) {
            qselectorarray[0] = "Country";
        }


        filterselect();

        if (filtercount > 0) {
            var data = csv;

            for (j = 0; j < filterarray.length; j++) {
                var t;
                t = data.filter(function (d, i) { return filterarray[j].values.indexOf(d[filterarray[j].title]) >= 0 });
                data = t;
            }
        } else {
            var data = csv; // so that no boxes checked shows all data
        }


        var rolledup = d3.rollup(data, v => v.length, d => d[qselectorarray[0]], d => d[qselectorarray[1]]);
        console.log('weve rolled up');
        console.log(rolledup);

        console.log('Now time to convert map to array');
        var rolledupgrouparray = Array.from(rolledup);
        console.log('weve created the array');
        console.log(rolledupgrouparray);
        console.log('Now time to convert nested map to array');
        for (i = 0; i < rolledupgrouparray.length; i++) {
            rolledupgrouparray[i][1] = Array.from(rolledupgrouparray[i][1]);
        }
        console.log('weve created the nested array');
        console.log(rolledupgrouparray);
        for (i = 0; i < rolledupgrouparray.length; i++) {
            rolledupgrouparray[i][1].sort(function (x, y) { return d3.ascending(x[0], y[0]); });
        }

        var bardata = []
        for (var i = 0; i < rolledupgrouparray.length; i++) {
            var group = new groupbardata();
            var xarray = [];
            var yarray = [];
            for (var j = 0; j < rolledupgrouparray[i][1].length; j++) {
                xarray.push(rolledupgrouparray[i][1][j][0]);
                yarray.push(rolledupgrouparray[i][1][j][1]);
            }
            group.name = rolledupgrouparray[i][0];
            group.type = 'bar';
            group.x = xarray;
            group.y = yarray;
            bardata.push(group);
        }
        console.log(bardata);

        var layout = { barmode: 'group', barnorm: 'percent' };

        Plotly.newPlot('plotly-bar', bardata, layout);
    }

    function generateparset(csv) {
        filterselect();

        if (filtercount > 0) {
            var data = csv;

            for (j = 0; j < filterarray.length; j++) {
                var t;
                t = data.filter(function (d, i) { return filterarray[j].values.indexOf(d[filterarray[j].title]) >= 0 });
                data = t;
            }
        } else {
            var data = csv; // so that no boxes checked shows all data
        }

        var parsetVisWidth = document.getElementById("vis-container").offsetWidth;
        console.log('The vis container is ' + parsetVisWidth + 'px');

        var margin = { top: 50, right: 25, bottom: 50, left: 25 },
            width = parsetVisWidth - margin.left - margin.right,
            height = (400 * (qselectorarray.length - 1)) - margin.top - margin.bottom;

        if (qselectorarray === undefined || qselectorarray.length === 0) {
            qselectorarray = ["Country", "Device_donated_on"]
        }

        var chart = d3.parsets()
            .width(width)
            .height(height)
            .dimensions(qselectorarray)
            .tension(.5);

        var collator = new Intl.Collator(undefined, {
            numeric: true,
            sensitivity: 'base'
        });

        $("#vis").empty()

        var svg = d3.select("#vis").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")

        svg.datum(data).call(chart);
    };



    function generatechart() {
        qselector();

        if (qselectorarray === undefined || qselectorarray === null) {
            $(".inline-validationtext").show();
        } else if (qselectorarray.length == 1) {
            $(".inline-validationtext").hide();
            d3.csv("All_data_with_dates_and_filtered.csv", function (error, csv) {
                singlechart(csv);
            })
        } else if (qselectorarray.length == 2) {
            $(".inline-validationtext").hide();
            d3.csv("All_data_with_dates_and_filtered.csv", function (error, csv) {
                $("#vis").empty()
                generateparset(csv);
                groupchart(csv);
            })
        } else {
            $(".inline-validationtext").hide();
            d3.csv("All_data_with_dates_and_filtered.csv", function (error, csv) {
                $("#vis").empty()
                generateparset(csv);
            })
        };
    }

    var pielegend;

    window.onresize = function () {

        qselector();

        var visWidth = document.getElementById("vis-container").offsetWidth;
        var barDiv = document.getElementById("plotly-bar");
        var pieDiv = document.getElementById("plotly-pie");

        if (visWidth < 925) {
            pielegend = false;
        } else {
            pielegend = true;
        }


        if (qselectorarray.length == 1) {
            Plotly.relayout(barDiv, {
                width: 0.9 * visWidth,

            })
            Plotly.relayout(pieDiv, {
                width: 0.9 * visWidth,
                showlegend: pielegend
            })
        } else if (qselectorarray.length == 2) {
            Plotly.relayout(barDiv, {
                width: 0.9 * visWidth
            })
        } else {
        };
    }
    $("input[name=qselector]").change(generatechart);
    $("#generate").click(generatechart);
    $('.list-group-sortable').sortable({
        placeholderClass: 'list-group-item'
    });
    $('.list-group-sortable').sortable().on("sortupdate", function (e, ui) {
        generatechart();
    });

    $(filter_id).on('change.select2', function (e) {
        filterselect();
        if (qselectorarray.length > 0) { generatechart(); }
    });

</script>

<style>
</style>

<div class="parsets tooltip"></div>
