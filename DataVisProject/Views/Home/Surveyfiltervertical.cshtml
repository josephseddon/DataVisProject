@{
    ViewData["Title"] = "Survey Data";
}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link href="~/css/d3.parsets.css" rel="stylesheet" />
<link href="~/lib/UI-Dropdown-master/dropdown.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/css/select2.min.css" rel="stylesheet" />

<style>
    .csvcolumn-list {
        -webkit-column-count: 1;
        -moz-column-count: 1;
        column-count: 1;
    }

        .csvcolumn-list li {
            flex: 1 0 25%;
        }
    .widget {
        content: "";
        display: table;
        clear: both;
        width: 100%;
    }
    .filter-container {
        float:left;
        width:25%;
    }
    .select-container {
        float: left;
        width: 20%;
    }
    .vis-container {
        float: left;
        width: 55%;
    }

    #generate {
        border: solid 2px #36c;
        width: 200px;
        background: #36c;
        font-weight: bold;
        color: #fff;
        height: 40px;
        border-radius: 4px;
        text-align: center;
        margin: 9px auto;
        padding-top: 9px;
    }

    #vis svg {
        margin: auto;
        display: block;
    }

    .filter-selected{
        background-color: #36c;
        color: #fff;
    }
</style>
<div class="widget">
    <div class="filter-container">
        <legend>Filters</legend>
    </div>
    <div class="vis-container">
        <div id="generate">Generate chart</div>
        <div>

            <div id="vis"></div>
        </div>
    </div>
    <div class="select-container">
        <fieldset>
            <legend>Display selection</legend>
            <ul class="list-group list-group-sortable csvcolumn-list"></ul>
        </fieldset>

    </div>


    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="~/js/d3.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="~/js/d3.parsets.js"></script>
    <script src="~/js/highlight.js"></script>
    <script src="~/js/jquery.sortable.js"></script>
    <script src="~/lib/UI-Dropdown-master/dropdown.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/select2.min.js"></script>
    <script>
        var datacolumns;
        var i;
        var datasummary = [];

        function column(a, b) {
            this.title = a;
            this.values = b;
        }


        d3.csv('https://localhost:44318/All_data_with_dates_and_filtered.csv', function (error, csv) {
            datacolumns = d3.keys(csv[0]);
            datacolumnssize = datacolumns.length;

            for (i = 2; i < datacolumns.length; i++) {
                var columnname = datacolumns[i];
                var columnuniques = d3.map(csv, function (d) { return d[datacolumns[i]]; }).keys();
                console.log(columnname);
                console.log(columnuniques);
                var columnsummary = new column(columnname, columnuniques)
                console.log(columnsummary);
                datasummary.push(columnsummary);
            }
            console.log('Data summary has ' + datasummary.length + ' objects');
            console.log(datasummary);

            var collator = new Intl.Collator(undefined, {
                numeric: true,
                sensitivity: 'base'
            });

            for (i = 2; i < datacolumnssize; i++) {

                $(".csvcolumn-list").append('<li class="list-group-item" draggable="true"> <label class="" for= "check-' + datacolumns[i] + '">' + datacolumns[i] + '<input class="filter-list-item" type="checkbox" name="qselector" id="check-' + datacolumns[i] + '" value="' + datacolumns[i] + '"></label ></li>');
            }

            $('.list-group-sortable').sortable({
                placeholderClass: 'list-group-item'
            });

            var filter_on = 'Country';

            var filter_list = d3.map(csv, function (d) {
                return d[filter_on];
            }).keys();

            filter_list.sort(collator.compare);

            console.log(filter_list);
            filterlength = filter_list.length;

            for (i = 0; i < filter_list.length; i++) {
                console.log(i);
                $(".filter-list").append('<li class=""> <label for= "Source">' + filter_list[i] + '<input type="checkbox" name="qfilter" class="filter-check" id="' + filter_list[i] + '" value="' + filter_list[i] + '"></label ></li>');
            }

            for (i = 0; i < datasummary.length; i++) {

                var filter_title = datasummary[i].title;
                console.log('Beginning build of' + filter_title + ' filter');
                var filter_uniques = datasummary[i].values;

                $(".filter-container").append('<select class="js-example-basic-multiple ' + filter_title + '-filter" multiple="" style="width:320px;""></select>');
                $("." + filter_title + "-filter").append('<option value="">' + filter_title + '</option>');

                for (j = 0; j < filter_uniques.length; j++) {
                    $("." + filter_title + "-filter").append('<option value="' + filter_uniques[j] + '">' + filter_uniques[j] + '</option>');
                }

                $('.' + filter_title + "-filter").select2({
                    placeholder: filter_title,
                    tags: true
                });

            }


            var filterarray = [];
            var filter_id = '.' + filter_on + '-filter';
            $('.Country-filter').on('change.select2', function (e) {
                filterarray = [];
                $('.Country-filter').find(':selected').each(function () {
                    filterarray.push($(this).val());
                    console.log("qselectorarray array added")
                });
                console.log(filterarray)
            });


            $('.filter-list-item').click(function () {
                $(this).parent().toggleClass('filter-selected')
            })
        });
    </script>

    <script>
        d3.rebind = function (target, source) {
            var i = 1, n = arguments.length, method;
            while (++i < n) target[method = arguments[i]] = d3_rebind(target, source, source[method]);
            return target;
        };

        function d3_rebind(target, source, method) {
            return function () {
                var value = method.apply(source, arguments);
                return value === source ? target : value;
            };
        }

        d3.functor = function functor(v) {
            return typeof v === "function" ? v : function () {
                return v;
            };
        };
    </script>

    <script>
        var filter_on = 'Country';
        var filter_id = '.' + filter_on + '-filter';
        var qselectorarray;
        var filterarray;
        var filtercount;

        function qselector() {
            qselectorarray = [];
            console.log("qselectorarray reset");
            $("input:checkbox[name=qselector]:checked").each(function () {
                qselectorarray.push($(this).val());
                console.log("qselectorarray array added")
            });
            generatechart();
        }

        function filterselect() {
            filterarray = [];
            filtercount = 0;
            for (i = 0; i < datasummary.length; i++) {
                var filterselected = [];
                $('.' + datasummary[i].title + '-filter').find(':selected').each(function () {
                    filterselected.push($(this).val());
                    console.log(filterselected)
                    filtercount++;
                    console.log(filtercount)
                });
                if (filterselected.length > 0) { filterarray.push(new column(datasummary[i].title, filterselected)) }

            }
            console.log(filterarray)
        }


        function generatechart() {
            
            var margin = { top: 50, right: 0, bottom: 50, left: 0 },
                width = 650 - margin.left - margin.right,
                height = (500 * (qselectorarray.length - 1)) - margin.top - margin.bottom;

            if (qselectorarray === undefined || qselectorarray.length === 0) {
                qselectorarray = ["Country", "Device_donated_on"]
            }

            var chart = d3.parsets()
                .width(width)
                .height(height)
                .dimensions(qselectorarray)
                .tension(.5);

            var collator = new Intl.Collator(undefined, {
                numeric: true,
                sensitivity: 'base'
            });

            var svg = d3.select("#vis").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")


            d3.csv("https://localhost:44318/All_data_with_dates_and_filtered.csv", function (error, csv) {
                filterselect();

                if (filtercount > 0) {
                    var data = csv;

                    for (j = 0; j < filterarray.length; j++) {
                        var t;
                        t = data.filter(function (d, i) { return filterarray[j].values.indexOf(d[filterarray[j].title]) >= 0 });
                        data = t;
                    }
                } else {
                    var data = csv; // so that no boxes checked shows all data
                }
                svg.datum(data).call(chart);
            });
        };

        $("input[name=qselector]").change(qselector);
        $("#generate").click(qselector);
        $('.list-group-sortable').sortable({
            placeholderClass: 'list-group-item'
        });
        $('.list-group-sortable').sortable().on("sortupdate", function (e, ui) {
            qselector();
        });

        $(filter_id).on('change.select2', function (e) {
            filterselect();
            if (qselectorarray.length > 0) { generatechart(); }
        });


    </script>

    <style>
    </style>

    <div class="parsets tooltip"></div>
